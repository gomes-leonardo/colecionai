generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ProductCondition {
  NEW
  USED
  OPEN_BOX
}

enum AuctionStatus {
  OPEN       
  CLOSED    
  CANCELLED 
}

enum ProductStatus {
  AVAILABLE
  SOLD
  IN_AUCTION
  RESERVED
}

enum ProductCategory {
  ACTION_FIGURES
  COLLECTIBLE_STATUES
  FUNKO_POP
  TRADING_CARDS
  COMIC_BOOKS
  MANGA
  RETRO_GAMES
  MINIATURES
  MODEL_KITS
  MOVIES_TV_COLLECTIBLES
  ANIME_COLLECTIBLES
  ART_BOOKS
  RARE_COLLECTIBLES
}

enum FeedbackType {
  BUG           
  SUGGESTION 
  COMPLIMENT  
  OTHER
}

model Feedback {
  id           String       @id @default(uuid())
  type         FeedbackType @default(OTHER)
  message      String       @db.Text
  rating       Int       
  visitor_name String?      @db.VarChar(100) 
  context      String?      
  created_at   DateTime     @default(now())

  @@map("feedbacks")
}

model Product {
  id          String           @id @default(uuid())
  name        String           @db.VarChar(255)
  price       Int
  description String           @db.Text
  category    ProductCategory
  condition   ProductCondition
  status      ProductStatus    @default(AVAILABLE)
  user_id     String
  banner      String?          @db.VarChar(255)
  created_at  DateTime         @default(now()) @db.Timestamp(6)
  updated_at  DateTime         @updatedAt
  
  auction     Auction?
  user        User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  conversations Conversation[]
  orders      Order[]

  @@map("products")
}

model User {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  email       String    @unique @db.VarChar(255)
  password    String    @db.VarChar(255)
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  is_verified Boolean   @default(false)
  products    Product[]
  usertoken   UserToken[]
  bids        Bid[]

  // Chat
  messages_sent       Message[] 
  conversations_buy   Conversation[] @relation("BuyerConversations")
  conversations_sell  Conversation[] @relation("SellerConversations")

  // Orders
  orders_buyer        Order[] @relation("BuyerOrders")
  orders_seller       Order[] @relation("SellerOrders")

  @@map("users")
}

model UserToken {
  id                   String   @id @default(uuid())
  reset_password_token String?
  verify_email_token   String?
  user_id              String
  created_at           DateTime @default(now()) @db.Timestamp(6)
  expires_at           DateTime
  user                 User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("usertoken")
}

model Auction {
  id          String        @id @default(uuid())
  start_date  DateTime
  end_date    DateTime
  start_price Decimal       @db.Decimal(10, 2)
  product_id  String        @unique
  product     Product       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  bids        Bid[]
  status      AuctionStatus @default(OPEN)

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("auctions")
}

model Bid {
  id         String   @id @default(uuid())
  amount     Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now())

  user_id    String
  user       User     @relation(fields: [user_id], references: [id])

  auction_id String
  auction    Auction  @relation(fields: [auction_id], references: [id])

  @@map("bids")
}

model Message {
  id              String   @id @default(uuid())
  content         String   @db.Text
  created_at      DateTime @default(now())
  
  read_at         DateTime? 

  conversation_id String
  sender_id       String

  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [sender_id], references: [id])

  @@map("messages")
}

model Conversation {
  id            String   @id @default(uuid())
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt 

  buyer_id      String
  seller_id     String
  product_id    String?

  buyer    User     @relation("BuyerConversations", fields: [buyer_id], references: [id])
  seller   User     @relation("SellerConversations", fields: [seller_id], references: [id])
  product  Product? @relation(fields: [product_id], references: [id])
  
  messages Message[]
  orders   Order[]

  @@map("conversations")
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Order {
  id              String      @id @default(uuid())
  final_price     Int         // Pre√ßo final negociado (em centavos)
  status          OrderStatus @default(PENDING)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  completed_at    DateTime?

  buyer_id        String
  seller_id       String
  product_id      String
  conversation_id String?

  buyer         User         @relation("BuyerOrders", fields: [buyer_id], references: [id])
  seller        User         @relation("SellerOrders", fields: [seller_id], references: [id])
  product       Product      @relation(fields: [product_id], references: [id])
  conversation  Conversation? @relation(fields: [conversation_id], references: [id])

  @@map("orders")
}